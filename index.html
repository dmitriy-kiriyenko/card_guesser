<!DOCTYPE html>
<html>
<head>
  <title>Guesser</title>
  <script type="text/javascript" src="/scripts/jquery.js"></script>
  <script type="text/javascript" src="/scripts/underscore.js"></script>
  <script type="text/javascript" src="/scripts/bacon.js"></script>
  <script type="text/javascript" src="/scripts/bacon-ui.js"></script>

  <style type="text/css">
    hr {
      clear: both;
      margin: 20px 0;
      visibility: hidden;
    }

    div.main div {
      float: left;
      margin-right: 10px;
    }

    div.main div.guess {
      margin-left: 40px;
    }

    div.main div img {
      max-height: 272px;
      max-width: 188px;
      cursor: pointer;
    }

    div.value div {
      float: left;
      margin-right: 10px;
    }

    div.value div.cancel img,
    div.value div.pick img {
      max-height: 136px;
      max-width: 94px;
      cursor: pointer;
    }

  </style>
</head>
<body>

  <div class="main">
    <div class="given given-0">
      <img src="/images/black_joker.png" alt="unknown" data-pick="0" />
    </div>

    <div class="given given-1">
      <img src="/images/black_joker.png" alt="unknown" data-pick="1" />
    </div>

    <div class="given given-2">
      <img src="/images/black_joker.png" alt="unknown" data-pick="2" />
    </div>

    <div class="given given-3">
      <img src="/images/black_joker.png" alt="unknown" data-pick="3" />
    </div>

    <div class="guess">
      <img src="/images/red_joker.png" alt="unknown" />
    </div>
  </div>

  <hr />

  <div class="value">
    <div class="pick">
      <img src="/images/ace_of_spades.png" alt="unknown" data-value="0" data-suite="0" />
    </div>
    <div class="pick">
      <img src="/images/2_of_spades.png" alt="unknown" data-value="1" data-suite="0" />
    </div>
    <div class="pick">
      <img src="/images/3_of_spades.png" alt="unknown" data-value="2" data-suite="0" />
    </div>
    <div class="pick">
      <img src="/images/4_of_spades.png" alt="unknown" data-value="3" data-suite="0" />
    </div>
    <div class="pick">
      <img src="/images/5_of_spades.png" alt="unknown" data-value="4" data-suite="0" />
    </div>
    <div class="pick">
      <img src="/images/6_of_spades.png" alt="unknown" data-value="5" data-suite="0" />
    </div>
    <div class="pick">
      <img src="/images/7_of_spades.png" alt="unknown" data-value="6" data-suite="0" />
    </div>
    <div class="pick">
      <img src="/images/8_of_spades.png" alt="unknown" data-value="7" data-suite="0" />
    </div>
    <div class="pick">
      <img src="/images/9_of_spades.png" alt="unknown" data-value="8" data-suite="0" />
    </div>
    <div class="pick">
      <img src="/images/10_of_spades.png" alt="unknown" data-value="9" data-suite="0" />
    </div>
    <div class="pick">
      <img src="/images/jack_of_spades.png" alt="unknown" data-value="10" data-suite="0" />
    </div>
    <div class="pick">
      <img src="/images/queen_of_spades.png" alt="unknown" data-value="11" data-suite="0" />
    </div>
    <div class="pick">
      <img src="/images/king_of_spades.png" alt="unknown" data-value="12" data-suite="0" />
    </div>
  </div>

  <hr />

  <div class="value">
    <div class="pick">
      <img src="/images/ace_of_clubs.png" alt="unknown" data-value="0" data-suite="1" />
    </div>
    <div class="pick">
      <img src="/images/2_of_clubs.png" alt="unknown" data-value="1" data-suite="1" />
    </div>
    <div class="pick">
      <img src="/images/3_of_clubs.png" alt="unknown" data-value="2" data-suite="1" />
    </div>
    <div class="pick">
      <img src="/images/4_of_clubs.png" alt="unknown" data-value="3" data-suite="1" />
    </div>
    <div class="pick">
      <img src="/images/5_of_clubs.png" alt="unknown" data-value="4" data-suite="1" />
    </div>
    <div class="pick">
      <img src="/images/6_of_clubs.png" alt="unknown" data-value="5" data-suite="1" />
    </div>
    <div class="pick">
      <img src="/images/7_of_clubs.png" alt="unknown" data-value="6" data-suite="1" />
    </div>
    <div class="pick">
      <img src="/images/8_of_clubs.png" alt="unknown" data-value="7" data-suite="1" />
    </div>
    <div class="pick">
      <img src="/images/9_of_clubs.png" alt="unknown" data-value="8" data-suite="1" />
    </div>
    <div class="pick">
      <img src="/images/10_of_clubs.png" alt="unknown" data-value="9" data-suite="1" />
    </div>
    <div class="pick">
      <img src="/images/jack_of_clubs.png" alt="unknown" data-value="10" data-suite="1" />
    </div>
    <div class="pick">
      <img src="/images/queen_of_clubs.png" alt="unknown" data-value="11" data-suite="1" />
    </div>
    <div class="pick">
      <img src="/images/king_of_clubs.png" alt="unknown" data-value="12" data-suite="1" />
    </div>
  </div>

  <hr />

  <div class="value">
    <div class="pick">
      <img src="/images/ace_of_diamonds.png" alt="unknown" data-value="0" data-suite="2" />
    </div>
    <div class="pick">
      <img src="/images/2_of_diamonds.png" alt="unknown" data-value="1" data-suite="2" />
    </div>
    <div class="pick">
      <img src="/images/3_of_diamonds.png" alt="unknown" data-value="2" data-suite="2" />
    </div>
    <div class="pick">
      <img src="/images/4_of_diamonds.png" alt="unknown" data-value="3" data-suite="2" />
    </div>
    <div class="pick">
      <img src="/images/5_of_diamonds.png" alt="unknown" data-value="4" data-suite="2" />
    </div>
    <div class="pick">
      <img src="/images/6_of_diamonds.png" alt="unknown" data-value="5" data-suite="2" />
    </div>
    <div class="pick">
      <img src="/images/7_of_diamonds.png" alt="unknown" data-value="6" data-suite="2" />
    </div>
    <div class="pick">
      <img src="/images/8_of_diamonds.png" alt="unknown" data-value="7" data-suite="2" />
    </div>
    <div class="pick">
      <img src="/images/9_of_diamonds.png" alt="unknown" data-value="8" data-suite="2" />
    </div>
    <div class="pick">
      <img src="/images/10_of_diamonds.png" alt="unknown" data-value="9" data-suite="2" />
    </div>
    <div class="pick">
      <img src="/images/jack_of_diamonds.png" alt="unknown" data-value="10" data-suite="2" />
    </div>
    <div class="pick">
      <img src="/images/queen_of_diamonds.png" alt="unknown" data-value="11" data-suite="2" />
    </div>
    <div class="pick">
      <img src="/images/king_of_diamonds.png" alt="unknown" data-value="12" data-suite="2" />
    </div>
  </div>

  <hr />

  <div class="value">
    <div class="pick">
      <img src="/images/ace_of_hearts.png" alt="unknown" data-value="0" data-suite="3" />
    </div>
    <div class="pick">
      <img src="/images/2_of_hearts.png" alt="unknown" data-value="1" data-suite="3" />
    </div>
    <div class="pick">
      <img src="/images/3_of_hearts.png" alt="unknown" data-value="2" data-suite="3" />
    </div>
    <div class="pick">
      <img src="/images/4_of_hearts.png" alt="unknown" data-value="3" data-suite="3" />
    </div>
    <div class="pick">
      <img src="/images/5_of_hearts.png" alt="unknown" data-value="4" data-suite="3" />
    </div>
    <div class="pick">
      <img src="/images/6_of_hearts.png" alt="unknown" data-value="5" data-suite="3" />
    </div>
    <div class="pick">
      <img src="/images/7_of_hearts.png" alt="unknown" data-value="6" data-suite="3" />
    </div>
    <div class="pick">
      <img src="/images/8_of_hearts.png" alt="unknown" data-value="7" data-suite="3" />
    </div>
    <div class="pick">
      <img src="/images/9_of_hearts.png" alt="unknown" data-value="8" data-suite="3" />
    </div>
    <div class="pick">
      <img src="/images/10_of_hearts.png" alt="unknown" data-value="9" data-suite="3" />
    </div>
    <div class="pick">
      <img src="/images/jack_of_hearts.png" alt="unknown" data-value="10" data-suite="3" />
    </div>
    <div class="pick">
      <img src="/images/queen_of_hearts.png" alt="unknown" data-value="11" data-suite="3" />
    </div>
    <div class="pick">
      <img src="/images/king_of_hearts.png" alt="unknown" data-value="12" data-suite="3" />
    </div>
  </div>

  <script type="text/javascript">
    var toImagePath = function (card) {
      var suite = card[0];
      var value = card[1];
      suites = ['spades', 'clubs', 'diamonds', 'hearts'];
      values = ['ace', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'jack', 'queen', 'king'];
      return '/images/' + values[value] + '_of_' + suites[suite] + '.png';
    }
    var setImage = function (src, image) {
      image.attr('src', src);
    }

    var findOutCard = function (array) {
      var source = array[0];
      var permutations = [ 'dummy', 12, 21, 102, 120, 201, 210];
      var codes = _.map(array.slice(1, 1+3), function (el) { return el[0] + el[1]*100 });
      var middle = _.difference(codes, [_.min(codes), _.max(codes)])[0];
      var signum = function (x) { return (x > 0) - (x < 0); }
      var permutation = +_.map(codes, function (el) { return signum(el - middle) + 1; }).join('');
      var step = _.indexOf(permutations, permutation);
      return [source[0], ((source[1] + step) % 13)];
    }

    var clicked = $('.value img').clickE().map(function (e) { return $(e.target); }).
                                           filter(function (el) { return el.attr('src') !== '/images/black_joker.png' } );
    var card = clicked.map(function (el) { return [+el.attr('data-suite'), +el.attr('data-value')]; });

    clicked.onValue(_.partial(setImage, '/images/black_joker.png'));

    var stage = clicked.map(function () { return 1; }).scan(0, function (acc, i) { return acc + i; });
    var image = stage.map(function (i) { return $('.main .given-' + i + ' img'); } );

    card.map(toImagePath).zip(image).onValues(setImage);

    var given = card.scan([], function (acc, i) { res = acc.slice(); res.push(i); return res; } );
    var done = stage.map(function (i) { return i >= 3; });

    var solution = given.filter(done).map(findOutCard);
    solution.map(toImagePath).zip(Bacon.constant($('.guess img'))).onValues(setImage);
  </script>

</body>
</html>
